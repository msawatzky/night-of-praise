---
export type Platform = 'spotify' | 'apple' | 'youtube';

const platforms: { id: Platform; label: string }[] = [
  { id: 'spotify', label: 'Spotify' },
  { id: 'apple', label: 'Apple Music' },
  { id: 'youtube', label: 'YouTube' },
];
---

<div style="display:flex; align-items:center; gap: 10px; flex-wrap:wrap;" data-platform-picker>
  <span class="kicker">Listen on</span>
  <label class="sr-only" for="platform">Preferred platform</label>
  <span class="select-wrap">
    <select class="select" id="platform" name="platform">
      {platforms.map((p) => (
        <option value={p.id}>{p.label}</option>
      ))}
    </select>
  </span>
</div>

<script is:inline>
  (() => {
    const STORAGE_KEY = 'nop.platform';
    const picker = document.querySelector('[data-platform-picker]');
    if (!picker) return;

    /** @type {HTMLSelectElement | null} */
    const select = picker.querySelector('select');
    if (!select) return;

    const valid = new Set(['spotify', 'apple', 'youtube']);
    const getPlatform = () => {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved && valid.has(saved)) return saved;
      return 'spotify';
    };

    const setPlatform = (p) => {
      localStorage.setItem(STORAGE_KEY, p);
      updateLinks(p);
    };

    const updateLinks = (platform) => {
      /** @type {NodeListOf<HTMLAnchorElement>} */
      const links = document.querySelectorAll('a[data-song-link]');
      links.forEach((a) => {
        const url = a.dataset[platform];
        if (!url) {
          a.setAttribute('aria-disabled', 'true');
          a.classList.add('secondary');
          a.removeAttribute('href');
          a.textContent = 'Link unavailable';
          return;
        }

        a.setAttribute('href', url);
        a.removeAttribute('aria-disabled');
        a.classList.remove('secondary');

        const label = platform === 'apple' ? 'Apple Music' : platform[0].toUpperCase() + platform.slice(1);
        a.textContent = `Listen on ${label}`;
      });
    };

    const initial = getPlatform();
    select.value = initial;
    updateLinks(initial);

    select.addEventListener('change', () => {
      const value = select.value;
      if (!valid.has(value)) return;
      setPlatform(value);
    });
  })();
</script>

