---
import BaseLayout from '../layouts/BaseLayout.astro';
import Setlist from '../components/Setlist.astro';

import event from '../data/event.json';
import rawSetlist from '../data/setlist.yml';

type Links = {
  spotify?: string;
  apple?: string;
  youtube?: string;
};

type Song = {
  title: string;
  artist?: string;
  links?: Links;
};

const songs = rawSetlist as Song[];
---

<BaseLayout title={`${event.title} | ${event.date} at ${event.time}`} description={event.inviteLine}>
  <main id="top">
    <nav class="chevrons" aria-label="Section navigation">
      <a class="chevron chevron-up" href="#home" aria-label="Previous section">
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M6 14l6-6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </a>
      <a class="chevron chevron-down" href="#details" aria-label="Next section">
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M6 10l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </a>
    </nav>

    <!-- Screen 1: Home -->
    <header class="screen hero" id="home" aria-label="Home">
      <div class="hero-top">
        <div class="hero-meta">{event.date} â€¢ {event.time}</div>
      </div>

      <div class="container">
        <div class="hero-inner">
          <img
            class="hero-logo"
            src="/logo.png"
            width="1080"
            height="1080"
            alt="Night of Praise"
            loading="eager"
            decoding="async"
          />
        </div>
      </div>

      <div class="hero-nav" aria-label="Primary navigation">
        <a class="btn secondary" href="#details">More info</a>
        <a class="btn secondary" href={event.mapUrl} target="_blank" rel="noopener">Directions</a>
        <a class="btn secondary" href="#setlist">Setlist</a>
      </div>
    </header>

    <!-- Screen 2: Details -->
    <section class="screen section" id="details" aria-label="Details">
      <div class="container">
        <div class="card">
          <div class="card-inner" style="display:grid; gap: 14px;">
            <div>
              <div class="kicker">Details</div>
              <div style="font-family: var(--font-serif); font-size: 30px; margin-top: 6px;">
                {event.inviteLine}
              </div>
            </div>

            <div class="muted" style="line-height: 1.55;">
              <div style="font-weight: 800; color: var(--text);">{event.locationName}</div>
              <div>{event.address}</div>
            </div>

            <div class="muted" style="line-height: 1.7;">
              A relaxed evening of worship and community. Come as you are, bring a friend, and join us in song.
            </div>

            <div style="display:flex; gap: 10px; flex-wrap: wrap;">
              <a class="btn secondary" href="#setlist">View setlist</a>
              <a class="btn secondary" href={event.mapUrl} target="_blank" rel="noopener">Open in Maps</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Screen 3: Setlist -->
    <div class="screen" style="align-items: stretch;">
      <div style="width: 100%;">
        <Setlist songs={songs} />
      </div>
    </div>
  </main>
</BaseLayout>

<script is:inline>
  (() => {
    const ids = ['home', 'details', 'setlist'];
    const sections = ids
      .map((id) => document.getElementById(id))
      .filter(Boolean);

    const up = document.querySelector('.chevron-up');
    const down = document.querySelector('.chevron-down');
    if (!up || !down || sections.length === 0) return;

    const setIndex = (idx) => {
      const prev = ids[Math.max(0, idx - 1)];
      const next = ids[Math.min(ids.length - 1, idx + 1)];

      up.setAttribute('href', `#${prev}`);
      down.setAttribute('href', `#${next}`);

      up.toggleAttribute('data-hidden', idx === 0);
      down.toggleAttribute('data-hidden', idx === ids.length - 1);
    };

    const observer = new IntersectionObserver(
      (entries) => {
        const best = entries
          .filter((e) => e.isIntersecting)
          .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
        if (!best) return;

        const idx = ids.indexOf(best.target.id);
        if (idx >= 0) setIndex(idx);
      },
      { threshold: [0.2, 0.35, 0.5, 0.65, 0.8] }
    );

    sections.forEach((el) => observer.observe(el));
    setIndex(0);
  })();
</script>

